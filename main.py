import os
import re  # Added for professional cleaning
from datetime import datetime
from langchain_ollama import OllamaLLM
from tools import SecurityTools
#
# 1. Config - UPDATED TO MATCH YOUR 'OLLAMA LIST'
TECH_MODEL = "llama3.2:latest"
COMPLIANCE_MODEL = "deepseek-r1:7b"  # Added ':7b' to fix the 404 error
OUTPUT_DIR = "output"
#
# Initialize both 'Council Members'
auditor = OllamaLLM(model=TECH_MODEL)
compliance_officer = OllamaLLM(model=COMPLIANCE_MODEL)
#
def clean_output(text):
    """
    Sanitization Layer:
    - Removes DeepSeek-R1 internal <think> blocks.
    - Collapses 3+ newlines into a clean double-space (fixes your newline error).
    - Strips leading/trailing whitespace.
    """
    # Remove internal thought process tags from DeepSeek
    text = re.sub(r'<think>[\s\S]*?</think>', '', text, flags=re.DOTALL)
    
    # Solve the '2+ consistent newlines' issue by collapsing 3+ gaps into 2
    text = re.sub(r'\n{3,}', '\n\n', text)
    
    return text.strip()
#
# 2. Setup Environment
if not os.path.exists(OUTPUT_DIR): 
    os.makedirs(OUTPUT_DIR)
#
files = [f for f in os.listdir("logs") if f.endswith(".txt")]
#
if files:
    content = SecurityTools.read_scan_log(files[0])
    
    # --- PHASE 1: TECHNICAL AUDIT ---
    print(f"\nüîç [PHASE 1] Agent 1: Technical Auditor ({TECH_MODEL}) is scanning...")
    tech_prompt = f"Identify the top 3 technical vulnerabilities in this scan: {content}"
    
    # Run Agent 1 and clean the output
    tech_findings = clean_output(auditor.invoke(tech_prompt))
    
    # NEW: Display live technical findings in terminal
    print("-" * 50)
    print(f"CRITICAL VULNERABILITIES DETECTED:\n\n{tech_findings}")
    print("-" * 50)
    
    # --- PHASE 2: COMPLIANCE REVIEW ---
    print(f"\n‚öñÔ∏è [PHASE 2] Agent 2: Compliance Strategist ({COMPLIANCE_MODEL}) is reviewing...")
    compliance_prompt = f"""
    Based on these technical findings:
    {tech_findings}
    
    Analyze the legal and compliance risks (e.g., GDPR, PCI-DSS). 
    Explain what fines or liabilities an organization faces due to these specific vulnerabilities.
    """
    
    # Run Agent 2 and clean the output
    compliance_findings = clean_output(compliance_officer.invoke(compliance_prompt))
#
    # NEW: Display live compliance risks in terminal
    print("-" * 50)
    print(f"LEGAL & COMPLIANCE IMPACT:\n\n{compliance_findings}")
    print("-" * 50)
#
    # 3. Assemble the Consolidated Report
    full_report = f"""# Consolidated AI Security & Compliance Report
**Date:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**Target:** {files[0]}
#
## I. Technical Audit (by {TECH_MODEL})
{tech_findings}
#
## II. Compliance & Liability Analysis (by {COMPLIANCE_MODEL})
{compliance_findings}
#
---
*Generated by the D:\\AI_COUNCIL Autonomous Framework*
"""
#
    # 4. Save
    report_filename = f"Consolidated_Audit_{datetime.now().strftime('%H%M%S')}.md"
    report_path = os.path.join(OUTPUT_DIR, report_filename)
    with open(report_path, "w", encoding="utf-8") as f:
        f.write(full_report)
    
    print(f"\n‚úÖ SUCCESS: Full Report Generated at: {report_path}")
#
else:
    print("Error: No log files found in \\logs.")